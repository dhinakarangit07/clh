name: üöÄ Django EC2 Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üõ°Ô∏è Set Permissions on EC2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          sudo mkdir -p /var/www/html/clh
          sudo chown -R $USER:$USER /var/www/html
          sudo chmod -R 777 /var/www/html

    - name: üì§ Upload Django Project to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        source: "."
        target: "/var/www/html/clh"

    - name: üöÄ Install & Deploy on EC2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        script: |
          # Update & install dependencies
          sudo apt update -y
          sudo apt install -y python3.11 python3.11-venv python3.11-dev build-essential libmysqlclient-dev mysql-server nginx curl
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt install -y nodejs
          sudo npm install -g pm2

          # Start MySQL if not running
          sudo systemctl start mysql
          sudo systemctl enable mysql

          # Navigate to project
          cd /var/www/html/clh

          # Python Virtual Environment
          python3.11 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # Django DB Migration
          python manage.py migrate
          python manage.py collectstatic --noinput

          # PM2 Gunicorn Restart
          pm2 delete django-app || true
          pm2 start venv/bin/gunicorn --name django-app --bind 0.0.0.0:8000 clh.wsgi:application
          pm2 save
          pm2 startup --silent

          # Reload NGINX
          sudo nginx -t
          sudo systemctl restart nginx
